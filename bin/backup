#!/bin/bash

ANCESTOR=$(ssh -i ~/.ssh/swrg-app-ssh-key.pem ubuntu@3.12.167.223 "docker image ls --filter reference=390844739459.dkr.ecr.us-east-2.amazonaws.com/sfern/swrg-app:latest --format '{{.ID}}'")
CONTAINER_NAME=$(ssh -i ~/.ssh/swrg-app-ssh-key.pem ubuntu@3.12.167.223 "docker ps --latest --quiet --filter label=service=swrg_app --filter label=role=web --filter status=running --filter status=restarting --filter ancestor=$ANCESTOR")
DB_PATH="/rails/storage/production.sqlite3"
BACKUP_DIR="/backups"
S3_BUCKET="swrg-app-prod-backups"

# Create SQLite backup
kamal app exec "sqlite3 $DB_PATH '.backup /tmp/backup.sqlite3'"

# Copy from container to host
docker cp $CONTAINER_NAME:/tmp/backup.sqlite3 $BACKUP_DIR/backup-$(date +%Y%m%d-%H%M%S).sqlite3

# Upload to S3
aws s3 cp $BACKUP_DIR/backup-*.sqlite3 s3://$S3_BUCKET/backups/

# Cleanup old backups (keep last 7 days)
find $BACKUP_DIR -name "backup-*.sqlite3" -mtime +7 -delete